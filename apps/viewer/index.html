<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS Engine WebGPU - Game Engine Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #2b2b2b;
            color: #e0e0e0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            font-size: 13px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Title Bar */
        .title-bar {
            background: linear-gradient(to bottom, #3c3c3c, #2b2b2b);
            border-bottom: 1px solid #1a1a1a;
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            user-select: none;
        }

        .title-bar .engine-name {
            color: #4CAF50;
            font-weight: 600;
            font-size: 14px;
        }

        .title-bar .project-name {
            margin-left: 8px;
            color: #b0b0b0;
        }

        /* Menu Bar */
        .menu-bar {
            background-color: #2b2b2b;
            border-bottom: 1px solid #1a1a1a;
            height: 32px;
            display: flex;
            align-items: center;
            padding: 0 8px;
        }

        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #3c3c3c;
        }

        /* Toolbar */
        .toolbar {
            background-color: #2b2b2b;
            border-bottom: 1px solid #1a1a1a;
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 8px;
        }

        .tool-button {
            background-color: #3c3c3c;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tool-button:hover {
            background-color: #4a4a4a;
            border-color: #5a5a5a;
        }

        .tool-button.active {
            background-color: #4CAF50;
            border-color: #66BB6A;
        }

        /* Main Layout Container */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Left Sidebar */
        .left-sidebar {
            width: 280px;
            background-color: #2b2b2b;
            border-right: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            min-width: 200px;
            resize: horizontal;
            overflow: auto;
        }

        /* Center Viewport Area */
        .viewport-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
        }

        .viewport-header {
            background-color: #2b2b2b;
            border-bottom: 1px solid #1a1a1a;
            height: 28px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            justify-content: space-between;
        }

        .viewport-title {
            color: #e0e0e0;
            font-size: 12px;
            font-weight: 500;
        }

        .viewport-controls {
            display: flex;
            gap: 4px;
        }

        .viewport-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #1e1e1e 100%);
            position: relative;
        }

        #canvas {
            border: 1px solid #4CAF50;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            background-color: #000;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 320px;
            background-color: #2b2b2b;
            border-left: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            min-width: 250px;
            resize: horizontal;
            overflow: auto;
        }

        /* Panel Styles */
        .panel {
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background-color: #3c3c3c;
            padding: 8px 12px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-header:hover {
            background-color: #4a4a4a;
        }

        .panel-title {
            font-weight: 500;
            font-size: 12px;
            color: #e0e0e0;
        }

        .panel-toggle {
            color: #b0b0b0;
            font-size: 10px;
            transition: transform 0.2s;
        }

        .panel-content {
            background-color: #2b2b2b;
            padding: 8px;
            display: block;
        }

        .panel.collapsed .panel-content {
            display: none;
        }

        .panel.collapsed .panel-toggle {
            transform: rotate(-90deg);
        }

        /* Status Bar */
        .status-bar {
            background-color: #007ACC;
            height: 22px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            color: white;
            justify-content: space-between;
        }

        .status-left {
            display: flex;
            gap: 16px;
        }

        .status-right {
            display: flex;
            gap: 8px;
        }

        /* Hierarchy Tree */
        .tree-item {
            padding: 2px 8px;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tree-item:hover {
            background-color: #3c3c3c;
        }

        .tree-item.selected {
            background-color: #4CAF50;
            color: white;
        }

        .tree-icon {
            width: 12px;
            height: 12px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Inspector Properties */
        .property-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #3c3c3c;
        }

        .property-label {
            color: #b0b0b0;
            font-size: 11px;
            min-width: 80px;
        }

        .property-value {
            background-color: #1e1e1e;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 11px;
            width: 120px;
        }

        /* Project Browser */
        .file-item {
            padding: 2px 8px;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-item:hover {
            background-color: #3c3c3c;
        }

        .file-icon {
            width: 14px;
            height: 14px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background-color: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #5a5a5a;
        }

        /* Resizer */
        .resize-handle {
            width: 4px;
            background-color: transparent;
            cursor: col-resize;
            position: relative;
        }

        .resize-handle:hover {
            background-color: #4CAF50;
        }

        /* Status and Error Display */
        .engine-status {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', monospace;
            border: 1px solid #4a4a4a;
        }

        .engine-status.error {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .engine-status.success {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .engine-status.warning {
            border-color: #FFA726;
            color: #FFA726;
        }
    </style>
</head>
<body>
    <!-- Title Bar -->
    <div class="title-bar">
        <span class="engine-name">RS Engine WebGPU</span>
        <span class="project-name">- Triangle Demo Project (Live Development Mode üîÑ)</span>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item">File</div>
        <div class="menu-item">Edit</div>
        <div class="menu-item">View</div>
        <div class="menu-item">Project</div>
        <div class="menu-item">Build</div>
        <div class="menu-item">Window</div>
        <div class="menu-item">Help</div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-button active">üè† Scene</button>
        <button class="tool-button">üéÆ Game</button>
        <button class="tool-button">üìã Inspector</button>
        <div style="margin-left: auto; display: flex; gap: 8px;">
            <button class="tool-button">‚ñ∂Ô∏è Play</button>
            <button class="tool-button">‚è∏Ô∏è Pause</button>
            <button class="tool-button">‚èπÔ∏è Stop</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <!-- Scene Hierarchy Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Scene Hierarchy</span>
                    <span class="panel-toggle">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="tree-item selected">
                        <span class="tree-icon">üè†</span>
                        <span>Triangle Scene</span>
                    </div>
                    <div class="tree-item" style="padding-left: 20px;">
                        <span class="tree-icon">üìπ</span>
                        <span>Main Camera</span>
                    </div>
                    <div class="tree-item" style="padding-left: 20px;">
                        <span class="tree-icon">üî∫</span>
                        <span>Triangle Mesh</span>
                    </div>
                    <div class="tree-item" style="padding-left: 20px;">
                        <span class="tree-icon">üí°</span>
                        <span>Directional Light</span>
                    </div>
                </div>
            </div>

            <!-- Project Browser Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Project</span>
                    <span class="panel-toggle">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="file-item">
                        <span class="file-icon">üìÅ</span>
                        <span>Assets</span>
                    </div>
                    <div class="file-item" style="padding-left: 20px;">
                        <span class="file-icon">üé≠</span>
                        <span>Materials</span>
                    </div>
                    <div class="file-item" style="padding-left: 20px;">
                        <span class="file-icon">üîß</span>
                        <span>Scripts</span>
                    </div>
                    <div class="file-item" style="padding-left: 20px;">
                        <span class="file-icon">üè†</span>
                        <span>Scenes</span>
                    </div>
                    <div class="file-item" style="padding-left: 40px;">
                        <span class="file-icon">üìÑ</span>
                        <span>TriangleDemo.scene</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Viewport -->
        <div class="viewport-container">
            <div class="viewport-header">
                <span class="viewport-title">Scene View - Triangle Demo</span>
                <div class="viewport-controls">
                    <span style="font-size: 10px; color: #b0b0b0;">WebGPU Viewport</span>
                </div>
            </div>
            <div class="viewport-content">
                <canvas id="canvas" width="800" height="600"></canvas>
                <div class="engine-status" id="status">
                    Initializing WebGPU Engine...
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <!-- Inspector Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Inspector</span>
                    <span class="panel-toggle">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #4CAF50;">Triangle Mesh</div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Transform</div>
                        <div class="property-row">
                            <span class="property-label">Position</span>
                            <input class="property-value" type="text" value="0, 0, 0" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Rotation</span>
                            <input class="property-value" type="text" value="0, 0, 0" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Scale</span>
                            <input class="property-value" type="text" value="1, 1, 1" readonly>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Mesh Renderer</div>
                        <div class="property-row">
                            <span class="property-label">Material</span>
                            <input class="property-value" type="text" value="Default" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Cast Shadows</span>
                            <input class="property-value" type="text" value="Yes" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rendering Settings Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Rendering</span>
                    <span class="panel-toggle">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="property-row">
                        <span class="property-label">Render Pipeline</span>
                        <input class="property-value" type="text" value="WebGPU" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Resolution</span>
                        <input class="property-value" type="text" value="800x600" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">VSync</span>
                        <input class="property-value" type="text" value="On" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Anti-Aliasing</span>
                        <input class="property-value" type="text" value="MSAA 4x" readonly>
                    </div>
                </div>
            </div>

            <!-- Performance Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Performance</span>
                    <span class="panel-toggle">‚ñº</span>
                </div>
                <div class="panel-content">
                    <div class="property-row">
                        <span class="property-label">FPS</span>
                        <input class="property-value" type="text" value="60" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Frame Time</span>
                        <input class="property-value" type="text" value="16.7ms" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Draw Calls</span>
                        <input class="property-value" type="text" value="1" readonly>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Triangles</span>
                        <input class="property-value" type="text" value="1" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <span>Ready</span>
            <span>|</span>
            <span>Scene: TriangleDemo</span>
            <span>|</span>
            <span>Objects: 4</span>
        </div>
        <div class="status-right">
            <span>WebGPU Active</span>
            <span>|</span>
            <span>60 FPS</span>
        </div>
    </div>

    <script>
        // Engine Status Management
        const statusDiv = document.getElementById('status');

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'engine-status ' + type;
        }

        // Panel Toggle Functionality
        function initializePanelToggles() {
            const panelHeaders = document.querySelectorAll('.panel-header');
            
            panelHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const panel = header.parentElement;
                    panel.classList.toggle('collapsed');
                });
            });
        }

        // Tree Item Selection - disabled, now handled by engine integration

        // ========== Engine Data Integration ==========

        // State tracking
        let currentSelectedType = 'none'; // 'camera', 'object', 'none'
        let currentSelectedName = '';
        let hierarchyInitialized = false;
        let lastHierarchyUpdate = 0;
        let lastEngineSelectedName = ''; // Track engine selection state

        // Update camera inspector with real data from engine
        function updateCameraInspector() {
            if (!Module || !Module.getCameraInfo) {
                return;
            }

            try {
                const cameraInfo = Module.getCameraInfo();

                // Find inspector panel
                const inspectorPanel = document.querySelector('.right-sidebar .panel:first-child .panel-content');
                if (!inspectorPanel) return;

                // Update inspector content for camera
                inspectorPanel.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: #4CAF50;">Main Camera</div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Transform</div>
                        <div class="property-row">
                            <span class="property-label">Position</span>
                            <input class="property-value" type="text" value="${cameraInfo.posX.toFixed(2)}, ${cameraInfo.posY.toFixed(2)}, ${cameraInfo.posZ.toFixed(2)}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Target</span>
                            <input class="property-value" type="text" value="${cameraInfo.targetX.toFixed(2)}, ${cameraInfo.targetY.toFixed(2)}, ${cameraInfo.targetZ.toFixed(2)}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Up Vector</span>
                            <input class="property-value" type="text" value="${cameraInfo.upX.toFixed(2)}, ${cameraInfo.upY.toFixed(2)}, ${cameraInfo.upZ.toFixed(2)}" readonly>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Camera Settings</div>
                        <div class="property-row">
                            <span class="property-label">FOV</span>
                            <input class="property-value" type="text" value="${cameraInfo.fov.toFixed(1)}¬∞" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Near Plane</span>
                            <input class="property-value" type="text" value="${cameraInfo.nearPlane.toFixed(2)}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Far Plane</span>
                            <input class="property-value" type="text" value="${cameraInfo.farPlane.toFixed(1)}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Aspect Ratio</span>
                            <input class="property-value" type="text" value="${cameraInfo.aspectRatio.toFixed(2)}" readonly>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating camera inspector:', e);
            }
        }

        // Update hierarchy with real objects from scene (only once)
        function initializeHierarchy() {
            if (!Module || !Module.getObjectNames || !Module.getObjectCount) {
                return false;
            }

            try {
                const objectCount = Module.getObjectCount();
                const objectNames = Module.getObjectNames();

                // Update hierarchy tree
                const hierarchyPanel = document.querySelector('.panel-content');
                if (!hierarchyPanel) return false;

                // Keep only the scene root and camera, clear rest
                const existingItems = hierarchyPanel.querySelectorAll('.tree-item');
                for (let i = 2; i < existingItems.length; i++) {
                    existingItems[i].remove();
                }

                // Add camera click handler
                const cameraItem = hierarchyPanel.querySelector('.tree-item:nth-child(2)');
                if (cameraItem) {
                    cameraItem.addEventListener('click', () => {
                        document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
                        cameraItem.classList.add('selected');
                        currentSelectedType = 'camera';
                        currentSelectedName = 'camera';

                        // Clear engine selection when camera is selected
                        if (Module && Module.selectObjectByName) {
                            Module.selectObjectByName('');
                            lastEngineSelectedName = '';
                        }

                        updateCameraInspector();
                    });
                }

                // Add objects from scene
                for (let i = 0; i < objectNames.size(); i++) {
                    const name = objectNames.get(i);
                    const newItem = document.createElement('div');
                    newItem.className = 'tree-item';
                    newItem.style.paddingLeft = '20px';
                    newItem.innerHTML = `
                        <span class="tree-icon">üßä</span>
                        <span>${name}</span>
                    `;

                    newItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
                        newItem.classList.add('selected');
                        currentSelectedType = 'object';
                        currentSelectedName = name;

                        // Sync selection to engine
                        if (Module && Module.selectObjectByName) {
                            Module.selectObjectByName(name);
                            lastEngineSelectedName = name;
                            console.log(`[GUI->Engine] Selecting: ${name}`);
                        }

                        updateObjectInspector(name);
                    });

                    hierarchyPanel.appendChild(newItem);
                }

                // Update object count in status bar
                updateStatusBar('Ready', `Objects: ${objectCount}`);

                console.log(`[GUI] Initialized hierarchy with ${objectCount} objects`);
                return true;
            } catch (e) {
                console.error('Error initializing hierarchy:', e);
                return false;
            }
        }

        // Update inspector with real object data
        function updateObjectInspector(objectName) {
            if (!Module || !Module.getObjectInfo) {
                return;
            }

            try {
                const objInfo = Module.getObjectInfo(objectName);

                // Find inspector panel
                const inspectorPanel = document.querySelector('.right-sidebar .panel:first-child .panel-content');
                if (!inspectorPanel) return;

                // Convert radians to degrees for rotation
                const rotXDeg = (objInfo.rotX * 180 / Math.PI).toFixed(1);
                const rotYDeg = (objInfo.rotY * 180 / Math.PI).toFixed(1);
                const rotZDeg = (objInfo.rotZ * 180 / Math.PI).toFixed(1);

                // Update inspector content for object
                inspectorPanel.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: #4CAF50;">${objInfo.name}</div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Transform</div>
                        <div class="property-row">
                            <span class="property-label">Position</span>
                            <input class="property-value" type="text" value="${objInfo.posX.toFixed(2)}, ${objInfo.posY.toFixed(2)}, ${objInfo.posZ.toFixed(2)}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Rotation</span>
                            <input class="property-value" type="text" value="${rotXDeg}¬∞, ${rotYDeg}¬∞, ${rotZDeg}¬∞" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Scale</span>
                            <input class="property-value" type="text" value="${objInfo.scaleX.toFixed(2)}, ${objInfo.scaleY.toFixed(2)}, ${objInfo.scaleZ.toFixed(2)}" readonly>
                        </div>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #e0e0e0;">Mesh Renderer</div>
                        <div class="property-row">
                            <span class="property-label">Visible</span>
                            <input class="property-value" type="text" value="${objInfo.visible ? 'Yes' : 'No'}" readonly>
                        </div>
                        <div class="property-row">
                            <span class="property-label">Has Model</span>
                            <input class="property-value" type="text" value="${objInfo.hasModel ? 'Yes' : 'No'}" readonly>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating object inspector:', e);
            }
        }

        // Sync selection from engine picking system to GUI
        function syncSelectionFromEngine() {
            if (!Module || !Module.getSelectedObjectName) {
                return;
            }

            try {
                const engineSelectedName = Module.getSelectedObjectName();

                // Debug: log selection state periodically
                if (window.debugSelectionCounter === undefined) {
                    window.debugSelectionCounter = 0;
                }
                window.debugSelectionCounter++;
                if (window.debugSelectionCounter % 60 === 0) { // Every 60 frames (1 second)
                    console.log(`[GUI Debug] Engine selection: "${engineSelectedName}", Last: "${lastEngineSelectedName}"`);
                }

                // Check if engine selection changed
                if (engineSelectedName !== lastEngineSelectedName) {
                    console.log(`[GUI] ‚ö° Selection changed! Engine: "${engineSelectedName}" (was: "${lastEngineSelectedName}")`);
                    lastEngineSelectedName = engineSelectedName;

                    if (engineSelectedName === '') {
                        // No selection in engine - clear GUI selection
                        console.log('[GUI] Clearing selection');
                        document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
                        currentSelectedType = 'none';
                        currentSelectedName = '';
                    } else {
                        // Engine has selected an object - update GUI
                        console.log(`[GUI] Engine selected: ${engineSelectedName}`);

                        // Find and select the corresponding tree item
                        const treeItems = document.querySelectorAll('.tree-item');
                        let found = false;

                        console.log(`[GUI] Searching in ${treeItems.length} tree items...`);
                        treeItems.forEach(item => {
                            // Get only the text content, skip the icon
                            const textSpan = item.querySelector('span:last-child');
                            const itemText = textSpan ? textSpan.textContent.trim() : item.textContent.trim();
                            console.log(`[GUI] Checking item: "${itemText}"`);

                            if (itemText === engineSelectedName) {
                                console.log(`[GUI] ‚úì Found match! Selecting: ${itemText}`);
                                // Remove selection from all
                                treeItems.forEach(i => i.classList.remove('selected'));
                                // Select this item
                                item.classList.add('selected');
                                currentSelectedType = 'object';
                                currentSelectedName = engineSelectedName;
                                found = true;

                                // Scroll into view if needed
                                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        });

                        if (!found) {
                            console.warn(`[GUI] ‚úó Object "${engineSelectedName}" not found in hierarchy`);
                        }
                    }
                }
            } catch (e) {
                console.error('Error syncing selection from engine:', e);
            }
        }

        // Main update loop for UI (60 FPS)
        function updateEngineUI() {
            if (!Module || !Module.getCameraInfo) {
                // Engine not ready, try again later
                setTimeout(updateEngineUI, 100);
                return;
            }

            // Initialize hierarchy once
            if (!hierarchyInitialized) {
                hierarchyInitialized = initializeHierarchy();
            }

            // Sync selection from engine (picking system)
            syncSelectionFromEngine();

            // Update inspector based on current selection
            if (currentSelectedType === 'camera') {
                updateCameraInspector();
            } else if (currentSelectedType === 'object' && currentSelectedName) {
                updateObjectInspector(currentSelectedName);
            }

            // Continue updating at 60 FPS
            requestAnimationFrame(updateEngineUI);
        }

        // Toolbar Button Handling
        function initializeToolbar() {
            const toolButtons = document.querySelectorAll('.tool-button');
            
            toolButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.textContent.includes('Scene') || button.textContent.includes('Game') || button.textContent.includes('Inspector')) {
                        // View mode buttons
                        toolButtons.forEach(b => {
                            if (b.textContent.includes('Scene') || b.textContent.includes('Game') || b.textContent.includes('Inspector')) {
                                b.classList.remove('active');
                            }
                        });
                        button.classList.add('active');
                    } else if (button.textContent.includes('Play')) {
                        updateStatus('Play mode activated', 'success');
                        updateStatusBar('Playing', '60 FPS');
                    } else if (button.textContent.includes('Stop')) {
                        updateStatus('Play mode stopped', 'info');
                        updateStatusBar('Ready', '60 FPS');
                    }
                });
            });
        }

        // Status Bar Update
        function updateStatusBar(mode, objectInfo) {
            const statusLeft = document.querySelector('.status-left');
            if (statusLeft) {
                statusLeft.innerHTML = `
                    <span>${mode}</span>
                    <span>|</span>
                    <span>Scene: SeobJJang Demo</span>
                    <span>|</span>
                    <span>${objectInfo || 'Objects: 0'}</span>
                `;
            }

            const statusRight = document.querySelector('.status-right');
            if (statusRight) {
                statusRight.innerHTML = `
                    <span>WebGPU Active</span>
                    <span>|</span>
                    <span>60 FPS</span>
                `;
            }
        }

        // Sidebar Resizing
        function initializeResizing() {
            const leftSidebar = document.querySelector('.left-sidebar');
            const rightSidebar = document.querySelector('.right-sidebar');
            
            let isResizing = false;
            let currentSidebar = null;
            
            // Add resize listeners
            leftSidebar.addEventListener('mousedown', (e) => {
                if (e.offsetX > leftSidebar.offsetWidth - 10) {
                    isResizing = true;
                    currentSidebar = leftSidebar;
                    document.body.style.cursor = 'col-resize';
                }
            });
            
            rightSidebar.addEventListener('mousedown', (e) => {
                if (e.offsetX < 10) {
                    isResizing = true;
                    currentSidebar = rightSidebar;
                    document.body.style.cursor = 'col-resize';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                if (currentSidebar === leftSidebar) {
                    const newWidth = Math.max(200, Math.min(600, e.clientX));
                    leftSidebar.style.width = newWidth + 'px';
                } else if (currentSidebar === rightSidebar) {
                    const newWidth = Math.max(250, Math.min(600, window.innerWidth - e.clientX));
                    rightSidebar.style.width = newWidth + 'px';
                }
            });
            
            document.addEventListener('mouseup', () => {
                isResizing = false;
                currentSidebar = null;
                document.body.style.cursor = 'default';
            });
        }

        // Enhanced WebGPU diagnostics
        async function checkWebGPUSupport() {
            console.log('üîç Running WebGPU diagnostics...');

            if (!navigator.gpu) {
                updateStatus('WebGPU is not supported in this browser', 'error');
                console.error('‚ùå navigator.gpu is not available');
                return false;
            }

            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    updateStatus('WebGPU adapter request failed', 'error');
                    console.error('‚ùå Failed to get WebGPU adapter');
                    return false;
                }

                console.log('‚úÖ WebGPU adapter obtained:', adapter);

                const device = await adapter.requestDevice();
                if (!device) {
                    updateStatus('WebGPU device request failed', 'error');
                    console.error('‚ùå Failed to get WebGPU device');
                    return false;
                }

                console.log('‚úÖ WebGPU device obtained:', device);
                updateStatus('WebGPU Engine initialized successfully!', 'success');
                return true;

            } catch (error) {
                updateStatus('WebGPU error: ' + error.message, 'error');
                console.error('‚ùå WebGPU error:', error);
                return false;
            }
        }

        // Initialize Emscripten Module BEFORE viewer.js loads
        window.Module = {
            canvas: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                console.log('üéØ Emscripten runtime initialized');
                updateStatus('WebGPU Engine started!', 'success');
            }
        };

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', () => {
            initializePanelToggles();
            initializeToolbar();
            initializeResizing();

            // Run WebGPU diagnostics
            checkWebGPUSupport();

            // Start engine UI update loop
            setTimeout(updateEngineUI, 1000); // Wait 1s for engine to initialize
        });

        // Override console methods to show status
        const originalError = console.error;
        const originalLog = console.log;

        console.error = function(...args) {
            const message = args.join(' ');
            updateStatus('Error: ' + message, 'error');
            originalError.apply(console, args);
        };

        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('initialized successfully')) {
                updateStatus('Triangle App running successfully!', 'success');
                updateStatusBar('Running', '60 FPS');
            } else if (message.includes('üéØ Triangle App')) {
                updateStatus('Triangle App initialized!', 'success');
            } else if (message.includes('Scene::initialize()')) {
                updateStatus('Initializing Scene...', 'info');
            } else if (message.includes('createCube')) {
                updateStatus('Creating cube resources...', 'info');
            } else if (message.includes('Added cube to scene')) {
                updateStatus('Cubes added to scene: ' + message.split('Total cubes: ')[1], 'success');
            }
            originalLog.apply(console, args);
        };

        // Catch unhandled errors
        window.addEventListener('error', (event) => {
            const errorMsg = event.error ? event.error.message : event.message;
            updateStatus('Runtime Error: ' + errorMsg, 'error');
            console.error('Unhandled error:', event.error || event);

            if (event.error && event.error.stack) {
                console.error('Stack trace:', event.error.stack);
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            let errorMsg = 'Unknown promise rejection';

            if (typeof event.reason === 'string') {
                errorMsg = event.reason;
            } else if (event.reason instanceof Error) {
                errorMsg = event.reason.message;
            } else if (event.reason && event.reason.toString) {
                errorMsg = event.reason.toString();
            }

            if (errorMsg.includes('Aborted(Assertion failed)')) {
                updateStatus('üí• Assertion Failed - Check console for details', 'error');
                console.error('üö® Emscripten Assertion Failed:');
                console.error('This usually indicates:');
                console.error('1. Memory access violation');
                console.error('2. Stack overflow');
                console.error('3. WebGPU initialization failure');
                console.error('4. Async timing issue');
            } else {
                updateStatus('Promise Error: ' + errorMsg, 'error');
            }

            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>

    <script async type="text/javascript" src="viewer.js"></script>
</body>
</html>
